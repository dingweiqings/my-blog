---
title: 线性同余
date: 2022-11-22 10:12:32
tags: 随机数
categories: 算法
---
# 随机数算法
生成真正随机数是比较难的，下面介绍一种常用的伪随机数算法
![lcg](/img/lcg.png)
![lcg-周期](/img/lcg-周期.png)
取到模数n的称为满周期
![lcg-证明](/img/lcg-条件.png)

# code实现
java中java.util.Random类的实现中，发生器的关键代码如下：
```java
private static final long multiplier = 0x5DEECE66DL;
    private static final long addend = 0xBL;
    private static final long mask = (1L << 48) - 1;


    protected int next(int bits) {
        long oldseed, nextseed;
        AtomicLong seed = this.seed;
        do {
            oldseed = seed.get();
            nextseed = (oldseed * multiplier + addend) & mask;
        } while (!seed.compareAndSet(oldseed, nextseed));
        return (int)(nextseed >>> (48 - bits));//丢弃低比特位，保留高比特位
    }

    public int nextInt() {
        return next(32);
    }
```

同时可以看到，上面实现中特意对比特位进行了截取，丢弃低比特位，保留高比特位。 

# 数学原理

下面根据[线性同余满周期的充分性证明中文版](/file/混合线性同余发生器的周期分析.pdf)论文中来介绍一下充分性,主要思想是得出递推式和x0的关系,将模数m做素数分解,这样会得到一个重要的简化定理，模数m的周期等于模数m素数分解得到的所有因数周期的最小公倍数.  

## 引理1(得到递推式)
 设{% mathjax %} {x_{i}} {% endmathjax %}是产生的随机数序列,且{% mathjax %} a \ge 2 {% endmathjax %},则有

{% mathjax %} x_{i+n}\equiv a^{n}x_{i}  + \frac{(a^{n} -1)c}{(a-1)} (\bmod m) {% endmathjax %} 其中{% mathjax %} k \ge 0{% endmathjax %},   

特别的，取 {% mathjax %} i = 0 {% endmathjax %},即有
  {% mathjax %} x_{n}\equiv a^{n}x_{0} + \frac{(a^{n} -1)c}{(a-1)} (\bmod m) {% endmathjax %}   

**证**:(用数学归纳法)   
当n=0显然成立;  
假设当n=k时成立,则当n=k+1时,有  
{% mathjax %}
\begin{aligned}
x_{i+k+1} &= ax_{i+k}+c (\bmod m) \newline
          &= a[a^{k}x_{i}+\frac{(a^k-1)c}{a-1}]+c(\bmod m) \newline
          &=a^{k+1}x_{i}+\frac{(a^{k+1}-a)c}{a-1}+c(\bmod m)\newline
          &=a^{k+1}x_{i}+\frac{(a^{k+1}-1)c}{a-1} (\bmod m)
\end{aligned}
{% endmathjax %} 

令{% mathjax %} i = 0 {% endmathjax %},即有
  {% mathjax %} x_{n}\equiv a^{n}x_{0}  + \frac{(a^{n} -1)c}{(a-1)} (\bmod m) {% endmathjax %}       

## 引理2(模数做素数分解)
设 {% mathjax %}x_{i}{% endmathjax %}是线性同余产生的随机数序列,周期为d,对m做素数分解,{% mathjax %} m=p_{1}^{\alpha _{1}}p_{2}^{\alpha _{2}}...p_{n}^{\alpha _{n}} {% endmathjax %},其中 {% mathjax %}p_{i}(i=1,2,...,n){% endmathjax %}为素数,{% mathjax %}\alpha _{i} \in N^{+}{% endmathjax %}.

记{% mathjax %}{x_{ji}}{% endmathjax %}是由(初始值,乘子,增量,模数)为{% mathjax %}(x_{j0},a_{j},c{j},m_{j}){% endmathjax %}确定的随机数序列,周期为 {% mathjax %}d_{j}{% endmathjax %},其中 {% mathjax %}j=1,2,...n,x_{j0}=x_{0}(\bmod m_{j}),a_{j}=a(\bmod m_{j}),m_{j}=p_{j}^{\alpha j}{% endmathjax %}, 则有：

{% mathjax %}d=lcm(d_{1},...,d_{n}){% endmathjax %} ,即d为 {% mathjax %}d_{1},...,d_{n}{% endmathjax %}的最小公倍数


**证**: 先证明素数分解只有2个数的情况,即 {% mathjax %}p_{1}^{\alpha _{1}}p_{2}^{\alpha _{2}}=m_{1}m_{2}{% endmathjax %}
故，{% mathjax %}(m_{1},m_{2})=1(两者互素){% endmathjax %},
{% mathjax %}x_{n}=(ax_{n-1}+c) (\bmod m_{1}m_{2}){% endmathjax %},由{% mathjax %}{x_{ji}}{% endmathjax %}定义知：


{% mathjax %}
\begin{split}
x_{1n}=(a_{1}x_{1,n-1}+c_{1}) (\bmod m_{1}) \\
x_{2n}=(a_{2}x_{2,n-1}+c{2}) (\bmod m_{2})
\end{split}
{% endmathjax %} 故根据同余性质,
{% mathjax %}x_{n}=(ax_{n-1}+c) (\bmod m_{1})即{% endmathjax %}
{% mathjax %}x_{n}=(a_{1}x_{1,n-1}+c_{1}) (\bmod m_{1}){% endmathjax %},于是{% mathjax %}x_{n}=(x_{1,n}) (\bmod m_{1}){% endmathjax %}.同理有{% mathjax %}x_{n}=(x_{2,n}) (\bmod m_{2}){% endmathjax %}.



不妨设{% mathjax %}d^{*}=lcm(d_{1},d_{2}){% endmathjax %},**下证：{% mathjax %}d^{*}=d{% endmathjax %}**   



一方面,由周期定义知,{% mathjax %}x_{k+d}=x_{k}{% endmathjax %},则{% mathjax %}x_{k+d}=x_{k}(\bmod m_{1}){% endmathjax %},由前面的结论知，{% mathjax %}x_{1,k+d}=x_{1,k}(\bmod m_{1}){% endmathjax %},从而由周期的定义知,{% mathjax %}d_{1}|d{% endmathjax %},同理{% mathjax %}d_{2}|d{% endmathjax %},故有最小公倍数的定义知,{% mathjax %}d^{*}|d{% endmathjax %},


另一方面,设{% mathjax %}h为d_{1},d_{2}任一公倍数{% endmathjax %},则由h是周期的倍数知


{% mathjax %}
\begin{aligned}
x_{k+h}&=x_{1,k} (\bmod m_{1})\\
&=a_{1}x_{1,k-1}+c_{1}(\bmod m_{1}) (递推)\\
&=ax_{1,k-1}+c(\bmod m_{1}) (由a_{1}的定义) \\
&=ax_{k-1}+c(\bmod m_{1}) (由前面结论) \\
&=x_{k}(\bmod m_{1}) 
\end{aligned}
{% endmathjax %}
同理有,
{% mathjax %}
x_{k+h}=x_{k}(\bmod m_{2}) 
{% endmathjax %}
综合上面2式，根据同余性质有
{% mathjax %}
x_{k+h}=x_{k}(\bmod m_{1}m_{2}) 
{% endmathjax %}
故有周期的定义知,{% mathjax %}d|h{% endmathjax %},**又{% mathjax %}h是d_{1},d_{2}的任一倍数{% endmathjax %}**,
故 {% mathjax %}d=lcm(d_{1},d_{2}){% endmathjax %}
对于素数分解2个以上的，由归纳法可知结论成立


**注意** 在原论文中，这个引理的证明有问题,下图中用箭头标出来了,如果 {% mathjax %}d_{1} | d 并且 d| d_{1}{% endmathjax %}的话,那么岂不是{% mathjax %}d_{1}=d{% endmathjax %},这个结论与事实矛盾
![lcg-prof](/img/lcg-prof-error.png)

## 引理3
设p为素数,{% mathjax %}\alpha \in N^{+},且p^{\alpha} > 2{% endmathjax %},   


如果 {% mathjax %}x=1(\bmod p^{\alpha}),
x\ne 1(\bmod p^{\alpha+1}),则x^{p}=1(\bmod p^{\alpha+1}),x^{p} \ne (\bmod p^{\alpha+2})
{% endmathjax %}.

**证**:(二项式定理展开)
由条件知, {% mathjax %}x=1+qp^{\alpha},其中q \in Z 且 q \nmid p(是素数){% endmathjax %},从而有
{% mathjax %}
\begin{aligned}
x^{p}&=(1+qp^{\alpha}) \\
    &=1+C_{p}^{1}qp^{\alpha}+C_{p}^{2}q^{2}p^{2\alpha}++...+C_{p}^{p-1}q^{p-1}p^{(p-1)\alpha}+q^{p}p^{p\alpha} \\
    &=1+qp^{\alpha+1}(1+C_{p}^{2}qp^{\alpha-1}+...+C_{p}^{p-1}q^{p-2}p^{(p-2)\alpha-1}+q^{p-1}p^{(p-1)\alpha-1}) \\
    &=1+qp^{\alpha+1}Q 
\end{aligned} 
{% endmathjax %}
{% mathjax %}
其中,Q=1+C_{p}^{2}qp^{\alpha-1}+...+C_{p}^{p-1}q^{p-2}p^{(p-2)\alpha-1}+q^{p-1}p^{(p-1)\alpha-1} \in Z
{% endmathjax %}
显然,{% mathjax %}x^{p}=1(\bmod p^{\alpha+1}),{% endmathjax %}


因 {% mathjax %}p^{\alpha} > 2,即当p{% endmathjax %},在组合数中总是可以分出一个p来,凑出{% mathjax %}p^{2}{% endmathjax %}这个因子(可分为p=2和p>2来讨论),所以p整除Q中带有组合数的项,但还有单独1这一项，


故
{% mathjax %}
p \nmid Q=1+C_{p}^{2}qp^{\alpha-1}+...+C_{p}^{p-1}q^{p-2}p^{(p-2)\alpha-1}+q^{p-1}p^{(p-1)\alpha-1}  
{% endmathjax %},故 {% mathjax %}x^{p} \ne 1(\bmod p^{\alpha+2}){% endmathjax %}

## 引理4
如果 {% mathjax %}a=1(\bmod 4),则\frac{a^{2^{\alpha}}-1}{a-1}=0(\bmod 2^{\alpha}),\alpha > 1 {% endmathjax %} 


**证**: {% mathjax %}a=3(\bmod 4) \Rightarrow a=3+4t,t \in Z , \Rightarrow a= 1+2(1+2t) \Rightarrow a=1(\bmod 2){% endmathjax %}

则， {% mathjax %}
\begin{aligned}
a^{2}&=(3+4t)^{2} \\
    &=9+24t+16t^{2} \\
    &=1+8(1+3t+2t^{2})\\
\Rightarrow a^{2}=1(\bmod 2^{3}), a^{2}\ne 1(\bmod 2^{4})
\end{aligned}
{% endmathjax %}
于是可以仍然满足引理3的条件，继续应用引理3，得到:
{% mathjax %}
\begin{split}
a^{4}=1(\bmod 2^{4}),...,a^{2^{\alpha-1}} =1 (\bmod 2^{\alpha-1}) \\
a^{4}\ne 1(\bmod 2{5}),...,a^{2^{\alpha-1}} \ne   1 (\bmod 2^{\alpha-1})
\end{split}
{% endmathjax %}
即


# 引用
1. [随机数课件](https://www.icst.pku.edu.cn/zlian/docs/20181023161643742238.pdf)
2. [线性同余满周期充分必要条件的证明](https://books.google.com.sg/books?hl=zh-CN&lr=&id=Zu-HAwAAQBAJ&oi=fnd&pg=PT17&ots=9ojjXoVxe_&sig=BqdI06kVqktyfMnAGL8MpvvQyns&redir_esc=y#v=onepage&q&f=false)
3. [线性同余满周期的充分性证明中文版](/file/混合线性同余发生器的周期分析.pdf)
4. [线性同余随机数](https://www.cnblogs.com/qcblog/p/8450427.html)